<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/header :: head}"></head>


<style>
    .detail-header {
        margin-bottom: 15px;
        padding: 12px;
        background: #eef5ff;
        border-radius: 10px;
        font-size: 15px;
        border-left: 4px solid #1976d2;
    }

    .detail-table-wrapper {
        max-height: 300px;  /* khi quá nhiều sẽ trượt */
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 10px;
    }

    .detail-table {
        width: 100%;
        border-collapse: collapse;
    }

    .detail-table th {
        background: #1976d2;
        color: white;
        padding: 10px;
        font-weight: 600;
    }

    .detail-table td {
        padding: 10px;
        text-align: center;
    }

    .detail-table tr:nth-child(even) {
        background: #f8fbff;
    }

    .detail-table tr:hover {
        background: #edf4ff;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
        margin: 0;
        padding: 20px;
    }

    h1 {
        text-align: center;
        color: #1a4971;
        margin-bottom: 30px;
        font-size: 2.2rem;
        font-weight: 600;
    }

    /* ĐỒNG NHẤT 100% với trang Quản lý bàn */
    .table-container {
        width: 95%;
        max-width: 1200px;
        margin: 0 auto;
        overflow-x: auto;


        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        padding: 20px;                 /* Giống hệt trang bàn */


        /* THÊM 4 DÒNG SAU ĐỂ CỐ ĐỊNH CHIỀU CAO */
        height: 680px;            /* bạn tự chọn con số này */
        min-height: 680px;        /* đảm bảo không bị co lại khi ít dữ liệu */
        max-height: 80vh;         /* không vượt quá 80% chiều cao màn hình */
        overflow-y: auto;         /* hiện thanh cuộn dọc khi tràn */
    }



    .table-container th {
        position: sticky;
        top: 0;
        background: #1976d2;
        color: white;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }



    table {
        width: 100%;
        border-collapse: collapse;
        margin: 0 auto;
        font-size: 15px;
    }

    th {
        background: #1976d2;
        color: white;
        padding: 14px 8px;
        text-align: center;
        font-weight: 600;
    }

    td {
        text-align: center;
        vertical-align: middle;
        padding: 12px 8px;
    }

    tr:nth-child(even) {
        background-color: #f8fbff;
    }

    tr:hover {
        background-color: #edf4ff;
    }

    /* Khi không có dữ liệu – cũng giống hệt trang bàn */
    .empty-message {
        text-align: center;
        padding: 80px 20px;
        color: #888;
        font-size: 1.2rem;
        background: #f9f9f9;
    }


    /*cho đống nút*/

    .btn-edit, .btn-delete, .btn-detail {
        padding: 6px 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        margin: 2px;
        color: white;
    }

    /* ============================
       NÚT PASTEL: EDIT / DELETE / DETAIL
       ============================ */

    /* EDIT – xanh dương pastel */
    .btn-edit {
        background: #64b5f6;      /* xanh pastel nhạt */
        color: white;
        padding: 7px 16px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(100,181,246,0.3);
    }
    .btn-edit:hover {
        background: #1976d2;      /* xanh đậm hơn */
        box-shadow: 0 4px 12px rgba(25,118,210,0.4);
    }

    /* DELETE – đỏ pastel */
    .btn-delete {
        background: #ef9a9a;      /* đỏ pastel nhạt */
        color: white;
        padding: 7px 16px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(239,154,154,0.3);
    }
    .btn-delete:hover {
        background: #e53935;      /* đỏ gốc đậm */
        box-shadow: 0 4px 12px rgba(229,57,53,0.4);
    }

    /* DETAIL – xanh lá pastel */
    .btn-detail {
        background: #81c784;      /* xanh lá pastel */
        color: white;
        padding: 7px 16px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(129,199,132,0.3);
    }
    .btn-detail:hover {
        background: #43a047;      /* xanh lá gốc đậm */
        box-shadow: 0 4px 12px rgba(67,160,71,0.4);
    }


    /* Popup overlay */
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.45);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    /* Popup box */
    .popup-box {
        background: white;
        width: 450px;
        padding: 25px;
        border-radius: 16px;
        box-shadow: 0 0 30px rgba(0,0,0,0.3);
        animation: fadeIn 0.25s ease-out;
    }

    .popup-header {
        font-size: 20px;
        font-weight: 700;
        color: #1976d2;
        margin-bottom: 15px;
    }

    .popup-close {
        float: right;
        cursor: pointer;
        color: #888;
        font-size: 20px;
    }

    .popup-close:hover {
        color: #444;
    }

    @keyframes fadeIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    .popup-input {
        width: 100%;
        padding: 12px;
        margin-bottom: 12px;
        border-radius: 10px;
        border: 2px solid #ddd;
    }

    .popup-btn-save {
        width: 100%;
        padding: 12px;
        background: #1976d2;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
    }

    .popup-btn-save:hover {
        background: #0d47a1;
    }
</style>

<body>
<div th:replace="~{layout/header :: menu}"></div>


<h1>Quản lý khách hàng</h1>

<!-- Bọc giống hệt trang Quản lý bàn -->
<div class="table-container">
    <table>
        <tr>
            <th>STT</th>
            <th>Họ tên</th>
            <th>Số điện thoại</th>
            <th>Địa chỉ</th>
            <th>Ngày tạo</th>
            <th>Số đơn thành công </th>
            <th>Hành động</th>
        </tr>

        <!-- Không có dữ liệu -->
        <tr th:if="${#lists.isEmpty(customers)}">
            <td colspan="6" class="empty-message">
                Chưa có khách hàng nào<br>
                Danh sách sẽ được cập nhật khi có khách đăng ký
            </td>
        </tr>

        <!-- Có dữ liệu -->
<!--        <tr th:each="c, iter : ${customers}">-->
<!--            <td th:text="${iter.index + 1}"></td>-->
<!--            <td th:text="${c.fullName}"></td>-->
<!--            <td th:text="${c.phone != null ? c.phone : '—'}"></td>-->
<!--            <td th:text="${c.address != null ? c.address : '—'}"></td>-->
<!--            <td th:text="${#temporals.format(c.createdAt, 'dd/MM/yyyy HH:mm')}"></td>-->
<!--            <td th:text="${c.get('completed')}"></td>-->


<!--            <td>-->
<!--                <button class="btn-edit"-->
<!--                        th:onclick="'openEdit(' + ${c.id} + ')'">-->
<!--                    Sửa-->
<!--                </button>-->
<!--                <button class="btn-delete"-->
<!--                        th:onclick="'openDelete(' + ${c.id} + ')'">-->
<!--                    Xóa-->
<!--                </button>-->
<!--                <button class="btn-detail"-->
<!--                        th:onclick="'openDetail(' + ${c.id} + ')'">-->
<!--                    Chi tiết-->
<!--                </button>-->
<!--            </td>-->
<!--        </tr>-->


        <tr th:each="c, iter : ${customers}">
            <td th:text="${iter.index + 1}"></td>

            <td th:text="${c['fullName']}"></td>
            <td th:text="${c['phone'] != null ? c['phone'] : '—'}"></td>
            <td th:text="${c['address'] != null ? c['address'] : '—'}"></td>

            <td th:text="${#temporals.format(c['createdAt'], 'dd/MM/yyyy HH:mm')}"></td>

            <td th:text="${c['completed']}"></td>

            <td>
                <button class="btn-edit" th:onclick="'openEdit(' + ${c['id']} + ')'">Sửa</button>
                <button class="btn-delete" th:onclick="'openDelete(' + ${c['id']} + ')'">Xóa</button>
                <button class="btn-detail" th:onclick="'openDetail(' + ${c['id']} + ')'">Chi tiết</button>
            </td>
        </tr>


    </table>

</div>


<div id="popup" class="popup-overlay">
    <div class="popup-box">
        <div class="popup-header">
            <span id="popupTitle"></span>
            <span class="popup-close" onclick="closePopup()">×</span>
        </div>

        <div id="popupContent"></div>
    </div>
</div>
<script th:inline="javascript">



    function openEdit(id) {
        fetch(`/api/customers/${id}`)
            .then(res => res.json())
            .then(c => {
                showPopup(
                    "Chỉnh sửa khách hàng",
                    `
                    <input type="hidden" id="cusId" value="${c.id}">

                    <label>Họ tên</label>
                    <input class="popup-input" id="fullName" value="${c.fullName}">

                    <label>Số điện thoại <span class="required">*</span></label>
                <input class="popup-input" id="phone" value="${c.phone ?? ''}"
                       placeholder="Ví dụ: 0901234567" maxlength="15">

                    <label>Địa chỉ</label>
                    <textarea class="popup-input" id="address">${c.address ?? ''}</textarea>

                    <button class="popup-btn-save" onclick="saveEdit()">Lưu thay đổi</button>
                `
                );
                const phoneInput = document.getElementById("phone");
                phoneInput.addEventListener("input", function (e) {
                    // Chỉ cho phép số và dấu + ở đầu
                    let value = e.target.value;
                    // Xóa mọi ký tự không phải số, trừ dấu + ở đầu
                    let cleaned = value.replace(/[^\d+]/g, '');
                    // Nếu có dấu +, phải đứng đầu
                    if (cleaned.indexOf('+') > 0) {
                        cleaned = cleaned.replace(/\+/g, '');
                    }
                    // Nếu có nhiều hơn 1 dấu +
                    if ((cleaned.match(/\+/g) || []).length > 1) {
                        cleaned = cleaned.replace(/\+/g, '');
                    }

                    // Cập nhật lại giá trị đã làm sạch
                    if (cleaned !== value) {
                        e.target.value = cleaned;
                    }

                    // Kiểm tra độ dài hợp lý (sau khi làm sạch)
                    const digitsOnly = cleaned.replace('+', '');
                    if (digitsOnly.length > 0 && (digitsOnly.length < 9 || digitsOnly.length > 15)) {
                        phoneInput.style.borderColor = "#e74c3c";
                    } else {
                        phoneInput.style.borderColor = "#ddd";
                    }
                });





            });
    }

    function saveEdit() {
        let body = {
            id: document.getElementById("cusId").value,
            fullName: document.getElementById("fullName").value,
            phone: document.getElementById("phone").value,
            address: document.getElementById("address").value
        };

        fetch("/api/customers/update", {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(body)
        }).then(res => {
            if (res.ok) location.reload();
        });
    }

    function openDelete(id) {
        fetch(`/api/customers/${id}`)
            .then(res => res.json())
            .then(c => {
                showPopup(
                    "Xóa khách hàng",
                    `
                        <p>Bạn có chắc muốn xóa khách hàng này?</p>

                        <div style="padding:10px; background:#f4f4f4; border-radius:8px; margin-bottom:15px;">
                            <b>ID:</b> ${c.id}<br>
                            <b>Họ tên:</b> ${c.fullName}<br>
                            <b>Số điện thoại:</b> ${c.phone ?? '—'}<br>
                            <b>Địa chỉ:</b> ${c.address ?? '—'}
                        </div>

                        <button class="popup-btn-save" style="background:#e53935"
                                onclick="confirmDelete(${c.id})">
                            Xóa ngay
                        </button>
                    `
                );
            });
    }

    function confirmDelete(id) {
        fetch(`/api/customers/delete/${id}`, {
            method: "DELETE"
        }).then(() => location.reload());
    }

    function openDetail(id) {
        fetch(`/api/customers/${id}/orders`)
            .then(res => res.json())
            .then(data => {

                let rows = data.orders.map(o => `
                <tr>
                    <td>${o.id}</td>
                    <td>${o.tableName}</td>
                    <td>${new Date(o.time).toLocaleString('vi-VN')}</td>
                    <td>${o.total.toLocaleString('vi-VN')} VNĐ</td>
                </tr>
            `).join("");

                let table = `
                <div class="detail-header">
                    <div><b>Món yêu thích:</b> ${data.favoriteDish} (${data.favoriteCount} lần)</div>
                    <div><b>Tổng số tiền đã tiêu:</b> ${data.totalSpent.toLocaleString('vi-VN')} VNĐ</div>
                </div>

                <div class="detail-table-wrapper">
                    <table class="detail-table">
                        <tr>
                            <th>Mã HĐ</th>
                            <th>Bàn</th>
                            <th>Thời gian</th>
                            <th>Tổng tiền</th>
                        </tr>
                        ${rows}
                    </table>
                </div>
            `;

                showPopup(`Chi tiết của ${data.customerName}`, table);
            });
    }



    function showPopup(title, content) {
        document.getElementById("popupTitle").innerHTML = title;
        document.getElementById("popupContent").innerHTML = content;
        document.getElementById("popup").style.display = "flex";
    }

    function closePopup() {
        document.getElementById("popup").style.display = "none";
    }

</script>


</body>
</html>