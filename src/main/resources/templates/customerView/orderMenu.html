<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{customerView/header :: head}">
    <title>Gọi món - Bàn [[${table.tableName}]]</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

</head>
<body>
<style>
    :root { --red: #ee4d2d; }
    * { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    body { background:#f5f7fa; padding-bottom:90px; }




    /* Header đỏ bên trong */
    .header {
        background:  #0d8bfd;
        color: white;
        text-align: center;
        padding: 30px 20px 25px;
    }
    .header h1 { font-size: 24px; font-weight: bold; }
    .header p { font-size: 17px; opacity: 0.95; margin-top: 6px; }

    /* Nội dung chính */
    .content {
        padding: 20px;
    }

    /* Tìm kiếm */
    .search {
        margin: 0 0 20px;
        background: white;
        border-radius: 12px;
        padding: 14px 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        border: 1px solid #eee;
    }
    .search input {
        border: none;
        outline: none;
        flex: 1;
        margin-left: 12px;
        font-size: 16px;
    }

    /* Danh sách món */
    .dish {
        display: flex;
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        margin-bottom: 14px;
    }
    .dish-img {
        width: 110px;
        height: 110px;
        object-fit: cover;
        background: #f0f0f0;
    }
    .dish-info {
        flex: 1;
        padding: 16px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .dish-name {
        font-size: 17px;
        font-weight: 600;
    }
    .dish-price {
        font-size: 19px;
        font-weight: bold;
        color: #0d8bfd;
    }

    /* Nút thêm */
    .add-box {
        align-self: flex-end;
        margin: 0 14px 14px 0;
    }
    .add-btn {
        width: 38px;
        height: 38px;
        background: #e3f2fd;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 26px;
        cursor: pointer;
    }
    .qty-box {
        display: flex;
        align-items: center;
        background: white;
        border: 3px solid #4dabf7;
        border-radius: 50px;
        height: 38px;
    }
    .qty-box button {
        width: 38px;
        background: transparent;
        border: none;
        color: #4dabf7;
        font-size: 22px;
        cursor: pointer;
    }
    .qty-box span {
        min-width: 50px;
        text-align: center;
        font-weight: bold;
        color: #4dabf7;
    }

    /* Phần món hiện tại */
    .current-order {
        margin: 30px 0;
        padding: 20px;
        background: #fff8e1;
        border-radius: 16px;
        border: 2px solid #e3f2fd;
    }
    .current-order h3 {
        color: #e3f2fd;
        margin-bottom: 15px;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .current-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px dashed #e3f2fd;
    }
    .current-item:last-child { border-bottom: none; }

    /* Mobile Bar */
    .mobile-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #eee;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        z-index: 999;
    }
    .mobile-left {
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    .mobile-icon {
        position: relative;
        width: 56px;
        height: 56px;
        background: #4dabf7;
        border-radius: 50%;
        color: white;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 16px;
    }
    .mobile-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: white;
        color: #4dabf7;
        width: 26px;
        height: 26px;
        border-radius: 50%;
        font-weight: bold;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .mobile-total {
        font-size: 20px;
        font-weight: bold;
        color:#4dabf7;
    }
    .mobile-btns {
        display: flex;
        gap: 10px;
    }
    .mobile-btn {
        padding: 12px 20px;
        border-radius: 50px;
        font-weight: bold;
        font-size: 16px;
        border: none;
        color: white;
    }
    .send-btn {
        background: #4dabf7;
    }
    .history-btn {
        background: #333;
    }

    /* Modal */
    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: none;
        align-items: flex-end;
        justify-content: center;
        z-index: 1000;
    }
    .modal.active { display: flex; }
    .modal-content {
        background: white;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        border-radius: 20px 20px 0 0;
        overflow: hidden;
        animation: slideUp 0.35s ease;
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-header {
        padding: 16px;
        background: #f8f9fa;
        font-weight: bold;
        font-size: 18px;
        text-align: center;
        position: relative;
        border-bottom: 1px solid #eee;
    }
    .modal-close {
        position: absolute;
        right: 16px;
        top: 14px;
        font-size: 26px;
        color: #999;
        cursor: pointer;
    }
    .modal-body {
        padding: 15px;
        max-height: 60vh;
        overflow-y: auto;
    }
    .modal-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .item-name { flex: 1; font-size: 15px; }
    .item-total { color: #4dabf7; font-weight: 600; }


    /* Container chính ở giữa - giống form quản lý */
    .order-container {
        width: 95%;
        max-width: 1200px;
        margin: 20px auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.12);
        overflow: hidden;




        /* THÊM 4 DÒNG SAU ĐỂ CỐ ĐỊNH CHIỀU CAO */
        height: 680px; /* bạn tự chọn con số này */
        min-height: 680px; /* đảm bảo không bị co lại khi ít dữ liệu */
        max-height: 80vh; /* không vượt quá 80% chiều cao màn hình */
        overflow-y: auto; /* hiện thanh cuộn dọc khi tràn */
    }



</style>
<!-- Header khách hàng -->
<div th:replace="~{customerView/header :: menu}"></div>


<h1 style="padding-top: 60px; text-align:center; color:#1a4971; margin-bottom:55px; font-size:2.2rem; font-weight:600;">
    Gọi món • Bàn <span th:text="${table.tableName}">01</span> •
    <span th:text="${order.customer?.fullName} ?: 'Quý khách'">Quý khách</span>
</h1>



<!-- Container chính -->
<div class="order-container">


    <div class="content">
        <!-- Tìm kiếm -->
        <div class="search">
            <i class="fas fa-search" style="color:#ccc;"></i>
            <input type="text" id="searchInput" placeholder="Tìm món tại quán..." onkeyup="filterDishes()">
        </div>



        <!-- Danh sách món -->
        <div th:each="dish : ${dishes}" th:if="${dish.active}" class="dish" th:data-id="${dish.id}">
            <img th:src="@{'https://via.placeholder.com/110?text=' + ${dish.dishName}}" class="dish-img" alt="">
            <div class="dish-info">
                <div class="dish-name" th:text="${dish.dishName}">Phở bò tái nạm</div>
                <div class="dish-price" th:text="${#numbers.formatInteger(dish.unitPrice, 3, 'COMMA')} + ' VNĐ'">75.000 VNĐ</div>
            </div>
            <div class="add-box">
                <button class="add-btn" onclick="addToCart(this)">+</button>
                <div class="qty-box" style="display:none;">
                    <button onclick="changeQty(this,-1)">–</button>
                    <span class="qty">0</span>
                    <button onclick="changeQty(this,1)">+</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mobile Bar -->
<div class="mobile-bar">
    <div class="mobile-left" onclick="openModal('cartModal')">
        <div class="mobile-icon">
            <i class="fas fa-shopping-cart"></i>
            <div class="mobile-badge" id="mobileCount">0</div>
        </div>
        <div class="mobile-total" id="mobileTotal">0đ</div>
    </div>
    <div class="mobile-btns">
        <button class="mobile-btn history-btn" onclick="openModal('historyModal')">Lịch sử</button>
        <button class="mobile-btn send-btn" id="mobileSendBtn" onclick="submitOrder()" disabled>Gửi đơn</button>
    </div>
</div>

<!-- Modal giỏ hàng -->
<div class="modal" id="cartModal">
    <div class="modal-content">
        <div class="modal-header">Giỏ hàng <span class="modal-close" onclick="closeModal()">×</span></div>
        <div class="modal-body" id="mobileCartItems">Chưa chọn món nào</div>
        <div style="padding:15px; font-size:18px; font-weight:bold; text-align:center;">
            Tổng: <span id="modalTotal">0đ</span>
        </div>
    </div>
</div>

<!-- Modal lịch sử -->
<div class="modal" id="historyModal">
    <div class="modal-content">
        <div class="modal-header">Lịch sử món đã gọi <span class="modal-close" onclick="closeModal()">×</span></div>
        <div class="modal-body" id="historyItems">
            <p style="text-align:center; color:#999; padding:40px;">Đang tải...</p>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const cart = {};
    const orderId = /*[[${order.id}]]*/ 0;
    const tableId = /*[[${table.id}]]*/ 0;

    // Load món hiện tại đang gọi
    function loadCurrentOrder() {
        fetch(`/tables/${tableId}/bill`)
            .then(r => r.json())
            .then(bill => {
                const container = document.getElementById('currentOrderItems');
                const section = document.getElementById('currentOrderSection');
                if (bill && bill.items && bill.items.length > 0) {
                    container.innerHTML = bill.items.map(i => `
                        <div class="current-item">
                            <span>${i.dishName || i.name} ×${i.quantity}</span>
                            <strong>${(i.unitPrice * i.quantity).toLocaleString('vi-VN')}đ</strong>
                        </div>
                    `).join('');
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });
    }

    function addToCart(btn) {
        const dish = btn.closest('.dish');
        const id = dish.dataset.id;
        cart[id] = (cart[id] || 0) + 1;
        updateDishUI(dish);
        updateAllDisplays();
    }

    function changeQty(btn, delta) {
        const dish = btn.closest('.dish');
        const id = dish.dataset.id;
        cart[id] += delta;
        if (cart[id] <= 0) delete cart[id];
        updateDishUI(dish);
        updateAllDisplays();
    }

    function updateDishUI(dish) {
        const qtyBox = dish.querySelector('.qty-box');
        const qtySpan = dish.querySelector('.qty');
        const addBtn = dish.querySelector('.add-btn');
        const qty = cart[dish.dataset.id] || 0;
        if (qty > 0) {
            addBtn.style.display = 'none';
            qtyBox.style.display = 'flex';
            qtySpan.innerText = qty;
        } else {
            addBtn.style.display = 'block';
            qtyBox.style.display = 'none';
        }
    }

    function updateAllDisplays() {
        let total = 0, count = 0;
        const mobileCart = document.getElementById('mobileCartItems');

        mobileCart.innerHTML = '';
        Object.keys(cart).forEach(id => {
            const dish = document.querySelector(`.dish[data-id="${id}"]`);
            const name = dish.querySelector('.dish-name').innerText;
            const price = parseInt(dish.querySelector('.dish-price').innerText.replace(/[^0-9]/g,''));
            const qty = cart[id];
            count += qty;
            total += price * qty;

            mobileCart.innerHTML += `<div class="modal-item"><div class="item-name">${name} ×${qty}</div><div class="item-total">${(price*qty).toLocaleString('vi-VN')}đ</div></div>`;
        });

        if (count === 0) {
            mobileCart.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">Chưa chọn món nào</p>';
        }

        document.getElementById('mobileCount').innerText = count;
        document.getElementById('mobileTotal').innerText = total.toLocaleString('vi-VN') + 'đ';
        document.getElementById('modalTotal').innerText = total.toLocaleString('vi-VN') + 'đ';
        document.getElementById('mobileSendBtn').disabled = count === 0;
    }

    function submitOrder() {
        const items = Object.entries(cart).map(([id, qty]) => ({ dishId: +id, quantity: qty }));
        fetch('/customer/order/add-items', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId, items })
        })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    alert('Đã gửi món thành công!');
                    location.reload();
                } else alert('Lỗi: ' + (res.message || 'Không thể gửi'));
            });
    }

    function openModal(id) {
        if (id === 'historyModal') {
            fetch(`/tables/${tableId}/bill`)
                .then(r => r.json())
                .then(bill => {
                    const container = document.getElementById('historyItems');
                    if (bill && bill.items && bill.items.length > 0) {
                        container.innerHTML = bill.items.map(i => `
                            <div class="modal-item">
                                <div class="item-name">${i.dishName || i.name} ×${i.quantity}</div>
                                <div class="item-total">${(i.unitPrice * i.quantity).toLocaleString('vi-VN')}đ</div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">Chưa gọi món nào</p>';
                    }
                });
        }
        document.getElementById(id).classList.add('active');
    }

    function closeModal() {
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    }

    function filterDishes() {
        const term = document.getElementById('searchInput').value.toLowerCase().trim();
        document.querySelectorAll('.dish').forEach(d => {
            const name = d.querySelector('.dish-name').innerText.toLowerCase();
            d.style.display = name.includes(term) ? 'flex' : 'none';
        });
    }

    // Khởi động
    loadCurrentOrder();
    updateAllDisplays();
</script>
</body>
</html>







