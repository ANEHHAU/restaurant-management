<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout/header :: head"></head>

<style>
    .qr-modal {
        display:none;
        position:fixed;
        top:0; left:0;
        width:100%; height:100%;
        background:rgba(0,0,0,0.5);
        justify-content:center;
        align-items:center;
        z-index:99999;
    }

    .qr-popup-box {
        background:white;
        padding:25px;
        border-radius:14px;
        text-align:center;
        animation:zoomIn .2s ease;
        box-shadow:0 10px 30px rgba(0,0,0,0.3);
    }

    .qr-modal-img {
        width:260px;
        height:260px;
        margin-bottom:20px;
    }

    .qr-btn {
        padding:10px 20px;
        border:none;
        border-radius:8px;
        font-size:15px;
        cursor:pointer;
        font-weight:600;
        margin:5px;
    }

    .qr-btn.save {
        background:#1976d2;
        color:white;
    }

    .qr-btn.close {
        background:#e0e0e0;
        color:#333;
    }

    @keyframes zoomIn {
        from { transform:scale(0.5); opacity:0; }
        to { transform:scale(1); opacity:1; }
    }



    body {font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f5f7fa;margin:0;padding:20px;}
    h1 {text-align:center;color:#1a4971;margin-bottom:30px;font-size:2.2rem;font-weight:600;}

    .table-container {
        width:95%; max-width:1200px; margin:0 auto; background:white;
        border-radius:12px; box-shadow:0 8px 25px rgba(0,0,0,0.1); padding:20px; overflow-x:auto;
    }
    table {width:100%; border-collapse:collapse; font-size:15px;}
    th {background:#1976d2; color:white; padding:14px 8px; text-align:center; font-weight:600;}
    td {text-align:center; vertical-align:middle; padding:12px 8px;}
    tr:nth-child(even){background-color:#f8fbff;}
    tr:hover{background-color:#edf4ff;}

    .status-badge {
        display:inline-block; padding:6px 14px; border-radius:8px;
        font-weight:bold; font-size:0.9em; min-width:80px; text-align:center;
    }
    .status-NEW         {background:#fff3cd; color:#856404;}
    .status-IN_PROGRESS {background:#d1ecf1; color:#0c5460;}
    .status-COMPLETED   {background:#d4edda; color:#155724;}
    .status-CANCELLED   {background:#f8d7da; color:#721c24;}

    .empty-message {text-align:center; padding:80px 20px; color:#888; font-size:1.2rem; background:#f9f9f9;}
</style>

<body>
<div th:replace="layout/header :: menu"></div>

<h1>Quản lý đơn hàng</h1>

<div class="table-container">
    <table>
        <tr>
            <th>STT</th>
            <th>Khách hàng</th>
            <th>Bàn</th>
            <th>Thời gian đặt</th>
            <th>Trạng thái</th>
            <th>Chi tiết món</th>
            <th>Mã đặt món</th>
        </tr>

        <tr th:if="${#lists.isEmpty(orders)}">
            <td colspan="5" class="empty-message">
                Chưa có đơn hàng nào<br>Đơn hàng sẽ xuất hiện khi khách gọi món
            </td>
        </tr>

        <tr th:each="o, iter : ${orders}">
            <td th:text="${iter.index + 1}"></td>

            <td>
                <span th:if="${o.customer != null}" th:text="${o.customer.fullName}"></span>
                <span th:if="${o.customer == null}" style="color:#666;font-style:italic">Khách vãng lai</span>
            </td>

            <td>
                <span th:if="${o.table != null}" th:text="${o.table.tableName}"></span>
                <span th:if="${o.table == null}" style="color:#999">—</span>
            </td>

            <td th:text="${#temporals.format(o.orderTime, 'dd/MM/yyyy HH:mm')}"></td>


            <td>
                <th:block th:switch="${o.status.name()}">
                    <span class="status-badge status-NEW" th:case="'NEW'">Chưa gọi món</span>
                    <span class="status-badge status-IN_PROGRESS" th:case="'IN_PROGRESS'">Đã gọi món</span>
                    <span class="status-badge status-COMPLETED" th:case="'COMPLETED'">Hoàn thành</span>
                    <span class="status-badge status-CANCELLED" th:case="'CANCELLED'">Đã hủy</span>
                    <span class="status-badge" th:case="*">[[${o.status}]]</span>
                </th:block>
            </td>

<!--            <td> nút hiển thị chi tiết các món và số luowngj và tổng tiền tên bàn tên khách</td>-->
            <td>
                <img class="qr-thumb"
                     th:src="@{'/qr/table/' + ${o.table.id}}"
                     th:attr="data-table-name=${'Bàn ' + o.table.tableName}"
                     onclick="openQrPopup(this)"
                     width="90" height="90"
                     style="cursor:pointer; border-radius:8px;"/>
            </td>


        </tr>
    </table>
</div>

<div id="qrPopup" class="qr-modal">
    <div class="qr-popup-box">
        <h2 id="qrTableName"
            style="margin-bottom: 15px; color:#1a4971; font-size:20px; font-weight:700;">
        </h2>

        <img id="qrPopupImg" class="qr-modal-img" src=""/>

        <div>
            <button class="qr-btn save" onclick="downloadQr()">Lưu QR</button>
            <button class="qr-btn close" onclick="closeQrPopup()">Đóng</button>
        </div>
    </div>
</div>



<script>
    let currentQrSrc = "";


    function openQrPopup(imgElement) {
        const src = imgElement.src;
        const tableName = imgElement.dataset.tableName; // đọc từ data-table-name

        currentQrSrc = src;

        document.getElementById("qrPopupImg").src = src;
        document.getElementById("qrTableName").innerText = tableName;

        document.getElementById("qrPopup").style.display = "flex";
    }



    function closeQrPopup() {
        document.getElementById("qrPopup").style.display = "none";
    }

    function downloadQr() {
        const link = document.createElement('a');
        link.href = currentQrSrc;
        link.download = "qr-table.png";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>


</body>
</html>
