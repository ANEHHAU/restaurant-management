<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout/header :: head"></head>

<style>


    .btn-view-items {
        background: #c59bff;  /* t√≠m nh·∫°t */
        color: white;
        border: none;
        padding: 6px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: 0.2s;
    }

    .btn-view-items:hover {
        background: #a86dff; /* t√≠m ƒë·∫≠m h∆°n */
    }
    .popup-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.4);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    .popup-box {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        width: 360px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        animation: fadeIn 0.2s ease;
    }
    .close-btn {
        margin-top: 10px;
        padding: 6px 12px;
        background: #ff6374;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
    @keyframes fadeIn {
        from {opacity: 0; transform: scale(0.9);}
        to {opacity: 1; transform: scale(1);}
    }
    /**/



    .qr-modal {
        display:none;
        position:fixed;
        top:0; left:0;
        width:100%; height:100%;
        background:rgba(0,0,0,0.5);
        justify-content:center;
        align-items:center;
        z-index:99999;
    }

    .qr-popup-box {
        background:white;
        padding:25px;
        border-radius:14px;
        text-align:center;
        animation:zoomIn .2s ease;
        box-shadow:0 10px 30px rgba(0,0,0,0.3);
    }

    .qr-modal-img {
        width:260px;
        height:260px;
        margin-bottom:20px;
    }

    .qr-btn {
        padding:10px 20px;
        border:none;
        border-radius:8px;
        font-size:15px;
        cursor:pointer;
        font-weight:600;
        margin:5px;
    }

    .qr-btn.save {
        background:#1976d2;
        color:white;
    }

    .qr-btn.close {
        background:#e0e0e0;
        color:#333;
    }

    @keyframes zoomIn {
        from { transform:scale(0.5); opacity:0; }
        to { transform:scale(1); opacity:1; }
    }



    body {font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f5f7fa;margin:0;padding:20px;}
    h1 {text-align:center;color:#1a4971;margin-bottom:30px;font-size:2.2rem;font-weight:600;}

    .table-container {
        width:95%; max-width:1200px; margin:0 auto; background:white;
        border-radius:12px; box-shadow:0 8px 25px rgba(0,0,0,0.1); padding:20px; overflow-x:auto;


        /* TH√äM 4 D√íNG SAU ƒê·ªÇ C·ªê ƒê·ªäNH CHI·ªÄU CAO */
        height: 680px;            /* b·∫°n t·ª± ch·ªçn con s·ªë n√†y */
        min-height: 680px;        /* ƒë·∫£m b·∫£o kh√¥ng b·ªã co l·∫°i khi √≠t d·ªØ li·ªáu */
        max-height: 80vh;         /* kh√¥ng v∆∞·ª£t qu√° 80% chi·ªÅu cao m√†n h√¨nh */
        overflow-y: auto;         /* hi·ªán thanh cu·ªôn d·ªçc khi tr√†n */


    }



    .table-container th {
        position: sticky;
        top: 0;
        background: #1976d2;
        color: white;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    table {width:100%; border-collapse:collapse; font-size:15px;}
    th {background:#1976d2; color:white; padding:14px 8px; text-align:center; font-weight:600;}
    td {text-align:center; vertical-align:middle; padding:12px 8px;}
    tr:nth-child(even){background-color:#f8fbff;}
    tr:hover{background-color:#edf4ff;}

    .status-badge {
        display:inline-block; padding:6px 14px; border-radius:8px;
        font-weight:bold; font-size:0.9em; min-width:80px; text-align:center;
    }
    .status-NEW         {background:#fff3cd; color:#856404;}
    .status-IN_PROGRESS {background:#d1ecf1; color:#0c5460;}
    .status-COMPLETED   {background:#d4edda; color:#155724;}
    .status-CANCELLED   {background:#f8d7da; color:#721c24;}

    .empty-message {text-align:center; padding:80px 20px; color:#888; font-size:1.2rem; background:#f9f9f9;}


    /*action button*/
    .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        margin: 2px;
        transition: 0.2s;
    }

    /* N√∫t s·ª≠a */
    .btn-edit {
        background: #b489ff;    /* t√≠m nh·∫°t */
        color: white;
    }
    .btn-edit:hover {
        background: #9d63ff;    /* t√≠m ƒë·∫≠m */
    }

    /* N√∫t x√≥a */
    .btn-delete {
        background: #ff6b6b;    /* ƒë·ªè */
        color: white;
    }
    .btn-delete:hover {
        background: #ff4a4a;    /* ƒë·ªè ƒë·∫≠m */
    }

</style>

<body>
<div th:replace="layout/header :: menu"></div>

<h1>Qu·∫£n l√Ω ƒë∆°n h√†ng</h1>

<div class="table-container">
    <table>
        <tr>
            <th>STT</th>
            <th>Kh√°ch h√†ng</th>
            <th>B√†n</th>
            <th>Th·ªùi gian ƒë·∫∑t</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Chi ti·∫øt m√≥n</th>
            <th>T·ªïng ti·ªÅn</th>
            <th>M√£ ƒë·∫∑t m√≥n</th>
            <th>H√†nh ƒë·ªông</th>
        </tr>

        <tr th:if="${#lists.isEmpty(orders)}">
            <td colspan="5" class="empty-message">
                Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o<br>ƒê∆°n h√†ng s·∫Ω xu·∫•t hi·ªán khi kh√°ch g·ªçi m√≥n
            </td>
        </tr>

        <tr th:each="o, iter : ${orders}">
            <td th:text="${iter.index + 1}"></td>

            <td>
                <span th:if="${o.customer != null}" th:text="${o.customer.fullName}"></span>
                <span th:if="${o.customer == null}" style="color:#666;font-style:italic">Kh√°ch v√£ng lai</span>
            </td>

            <td>
                <span th:if="${o.table != null}" th:text="${o.table.tableName}"></span>
                <span th:if="${o.table == null}" style="color:#999">‚Äî</span>
            </td>

            <td th:text="${#temporals.format(o.orderTime, 'dd/MM/yyyy HH:mm')}"></td>


            <td>
                <th:block th:switch="${o.status.name()}">
                    <span class="status-badge status-NEW" th:case="'NEW'">Ch∆∞a g·ªçi m√≥n</span>
                    <span class="status-badge status-IN_PROGRESS" th:case="'IN_PROGRESS'">ƒê√£ g·ªçi m√≥n</span>
                    <span class="status-badge status-COMPLETED" th:case="'COMPLETED'">Ho√†n th√†nh</span>
                    <span class="status-badge status-CANCELLED" th:case="'CANCELLED'">ƒê√£ h·ªßy</span>
                    <span class="status-badge" th:case="*">[[${o.status}]]</span>
                </th:block>
            </td>

            <td>
                <button class="btn-view-items"
                        th:onclick="|openItemsPopup(${o.id})|">
                    Xem m√≥n
                </button>


            </td>

            <td th:text="${#numbers.formatInteger(o.totalAmount, 3, 'COMMA')} + ' VNƒê'"></td>

            <td>
                <img class="qr-thumb"
                     th:src="@{'/qr/table/' + ${o.table.id}}"
                     th:attr="data-table-name=${'B√†n ' + o.table.tableName}"
                     onclick="openQrPopup(this)"
                     width="90" height="90"
                     style="cursor:pointer; border-radius:8px;"/>
            </td>
            <td>
                <button class="action-btn btn-edit" th:onclick="|openEditOrder(${o.id})|">
                    S·ª≠a
                </button>
                <button class="action-btn btn-delete" th:onclick="|openDeleteOrder(${o.id})|">
                    X√≥a
                </button>
            </td>


        </tr>
    </table>
</div>


<div id="editOrderModal" class="popup-overlay" style="display:none; z-index:99999;">
    <div class="popup-box" style="width:600px; max-height:90vh; overflow-y:auto;">
        <h3 style="margin-top:0; color:#1a4971;">Ch·ªânh s·ª≠a ƒë∆°n h√†ng #<span id="editOrderId"></span></h3>
        <div id="editOrderContent">ƒêang t·∫£i...</div>
        <div style="margin-top:20px; text-align:right;">
            <button class="qr-btn close" onclick="closeEditModal()">H·ªßy</button>
            <button class="qr-btn save" onclick="saveOrderChanges()">L∆∞u thay ƒë·ªïi</button>
        </div>
    </div>
</div>
<div id="deleteOrderModal" class="popup-overlay" style="display:none;">
    <div class="popup-box" style="width:420px;">
        <h3 style="margin:0 0 10px; color:#b71c1c;">X√°c nh·∫≠n x√≥a ƒë∆°n h√†ng</h3>

        <div id="deleteInfo" style="line-height:1.6; margin-bottom:20px; color:#444;"></div>

        <button class="qr-btn close" onclick="closeDeleteModal()">H·ªßy</button>
        <button class="qr-btn save" onclick="confirmDeleteOrder()">X√≥a ngay</button>
    </div>
</div>


<div id="qrPopup" class="qr-modal">
    <div class="qr-popup-box">
        <h2 id="qrTableName"
            style="margin-bottom: 15px; color:#1a4971; font-size:20px; font-weight:700;">
        </h2>

        <img id="qrPopupImg" class="qr-modal-img" src=""/>

        <div>
            <button class="qr-btn save" onclick="downloadQr()">L∆∞u QR</button>
            <button class="qr-btn close" onclick="closeQrPopup()">ƒê√≥ng</button>
        </div>
    </div>
</div>

<div id="itemPopup" class="popup-overlay" style="display:none;">
    <div class="popup-box">
        <h3>Chi ti·∫øt m√≥n ƒë√£ g·ªçi</h3>

        <!-- TH√äM BLOCK N√ÄY -->
        <div id="popupInfo"
             style="margin-bottom: 10px; color:#444; font-size:15px; line-height: 1.5;">
        </div>

        <ul id="itemList" style="padding-left:18px; margin-top:10px;"></ul>

        <button onclick="closeItemsPopup()" class="close-btn">ƒê√≥ng</button>
    </div>
</div>

<script>

    function openItemsPopup(orderId) {

        fetch(`/orders/${orderId}/items`)
            .then(res => res.json())
            .then(data => {

                // B√†n + kh√°ch
                document.getElementById("popupInfo").innerHTML = `
                <div><b>B√†n:</b> ${data.tableName}</div>
                <div><b>Kh√°ch:</b> ${data.customerName}</div>
            `;

                // List m√≥n
                const list = document.getElementById("itemList");
                list.innerHTML = "";

                data.items.forEach(i => {
                    list.innerHTML += `
                    <li>${i.dishName} √ó ${i.quantity}</li>
                `;
                });

                document.getElementById("itemPopup").style.display = "flex";
            });
    }


    function closeItemsPopup() {
        document.getElementById("itemPopup").style.display = "none";
    }



    let currentQrSrc = "";


    function openQrPopup(imgElement) {
        const src = imgElement.src;
        const tableName = imgElement.dataset.tableName; // ƒë·ªçc t·ª´ data-table-name

        currentQrSrc = src;

        document.getElementById("qrPopupImg").src = src;
        document.getElementById("qrTableName").innerText = tableName;

        document.getElementById("qrPopup").style.display = "flex";
    }


    function closeQrPopup() {
        document.getElementById("qrPopup").style.display = "none";
    }

    function downloadQr() {
        const link = document.createElement('a');
        link.href = currentQrSrc;
        link.download = "qr-table.png";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }










    // cho edit



    function openEditOrder(orderId) {
        document.getElementById("editOrderId").textContent = orderId;

        // L·∫§Y DATA FULL: b√†n, kh√°ch, m√≥n, status
        fetch(`/orders/${orderId}/edit`)
            .then(r => r.json())
            .then(data => {

                let html = "";

                // ---------------------
                // B√ÄN - label + dropdown ch·ªâ ch·ª©a INACTIVE


                // B√ÄN - Dropdown
                html += `
    <label><b>B√†n hi·ªán t·∫°i: ${data.tableName}</b></label>
    <select id="editTable"
            style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;margin-bottom:15px;">
        <option value="${data.tableId}">${data.tableName}</option>
`;
                data.availableTables.forEach(t => {
                    if (t.id !== data.tableId) {
                        html += `<option value="${t.id}">${t.tableName}</option>`;
                    }
                });
                html += `</select>`;



                // ---------------------
                // TR·∫†NG TH√ÅI
                // ---------------------
                html += `
                <label><b>Tr·∫°ng th√°i hi·ªán t·∫°i: ${data.status}</b></label>
                <select id="editStatus" style="width:100%;padding:8px;border-radius:6px;border:1px solid #1976d2;margin-bottom:15px;">
                    <option value="NEW" ${data.status === "NEW" ? "selected" : ""}>Ch∆∞a g·ªçi m√≥n</option>
                    <option value="IN_PROGRESS" ${data.status === "IN_PROGRESS" ? "selected" : ""}>ƒê√£ g·ªçi m√≥n</option>
                    <option value="COMPLETED" ${data.status === "COMPLETED" ? "selected" : ""}>Ho√†n th√†nh</option>
                    <option value="CANCELLED" ${data.status === "CANCELLED" ? "selected" : ""}>ƒê√£ h·ªßy</option>
                </select>
            `;


                // ---------------------
                // KH√ÅCH H√ÄNG
                // ---------------------
                if (data.customerPhone === "‚Äî" || data.customerPhone === null) {
                    // KH√îNG c√≥ s·ªë ‚Üí cho s·ª≠a 2 √¥
                    html += `
                    <label><b>T√™n kh√°ch h√†ng:</b></label>
                    <input id="editCustomerName" value="${data.customerName}" style="width:100%;padding:8px;margin-bottom:10px;border-radius:6px;border:1px solid #ddd;">

                    <label><b>S·ªë ƒëi·ªán tho·∫°i:</b></label>
                    <input id="editCustomerPhone" value="" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i..." style="width:100%;padding:8px;margin-bottom:15px;border-radius:6px;border:1px solid #ddd;">
                `;
                } else {
                    // C√ì s·ªë ‚Üí search dropdown
                    html += `
                    <label><b>Kh√°ch h√†ng: ${data.customerName} (${data.customerPhone})</b></label>
                    <input id="editCustomerSearch"
       oninput="searchCustomer(this.value)"
       placeholder="Nh·∫≠p t√™n ho·∫∑c s·ªë ƒëi·ªán tho·∫°i..."
       style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;">

<div id="customerResultBox"
     style="border:1px solid #eee;margin-top:6px;border-radius:6px;display:none;"></div>

<button id="resetCustomerBtn"
        style="margin-top:8px;display:none;padding:6px 12px;border-radius:6px;cursor:pointer;"
        onclick="resetCustomerSelect()">
    Ch·ªçn l·∫°i
</button>


                    <div id="customerDropdown" style="border:1px solid #ddd;border-radius:6px;display:none;max-height:150px;overflow-y:auto;"></div>
                `;
                }


                // ---------------------
                // GHI CH√ö
                // ---------------------
                html += `
                <label><b>Ghi ch√∫ c≈©: ${data.note || "‚Äî"}</b></label>
                <textarea id="editNote" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:20px;">${data.note || ""}</textarea>
            `;


                // ---------------------
                // DANH S√ÅCH M√ìN

                html += `<h4>Danh s√°ch m√≥n</h4>
    <div id="editItemsList">`;

                data.items.forEach(item => {
                    html += `
    <div class="item-row" style="display:flex;gap:10px;margin-bottom:8px;align-items:center;">
        <input type="text" value="${item.dishName}" disabled style="flex:1;">
        <input type="number" class="item-qty" data-dish="${item.dishId}" value="${item.quantity}" min="1" style="width:80px;">
        <span class="remove-item"
              onclick="this.parentElement.remove()"
              style="cursor:pointer;color:red;font-weight:bold;">√ó</span>
    </div>`;
                });

                html += `</div>`;




                // N√öT TH√äM M√ìN
                html += `
                <button type="button" onclick="addNewItemRow()"
                        style="padding:8px 14px;background:#43a047;color:white;border:none;border-radius:6px;margin-top:10px;">
                    + Th√™m m√≥n
                </button>
            `;

                document.getElementById("editOrderContent").innerHTML = html;
                document.getElementById("editOrderModal").style.display = "flex";
            });
    }


    // function openEditOrder(orderId) {
    //     document.getElementById("editOrderId").textContent = orderId;
    //
    //     fetch(`/orders/${orderId}/edit`)   // üëâ API m·ªõi: tr·∫£ v·ªÅ th√¥ng tin order ƒë·∫ßy ƒë·ªß
    //         .then(r => r.json())
    //         .then(data => {
    //
    //             let html = `
    //             <div class="form-row" style="display:flex; gap:15px; margin:15px 0;">
    //                 <div style="flex:1;">
    //                     <label><b>B√†n:</b></label>
    //                     <input type="text" value="${data.tableName}" disabled
    //                            style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
    //                 </div>
    //                 <div style="flex:1;">
    //                     <label><b>Tr·∫°ng th√°i:</b></label>
    //                     <select id="editStatus" style="width:100%; padding:8px; border:1px solid #1976d2; border-radius:6px;">
    //                         <option value="NEW" ${data.status==='NEW'?'selected':''}>Ch∆∞a g·ªçi m√≥n</option>
    //                         <option value="IN_PROGRESS" ${data.status==='IN_PROGRESS'?'selected':''}>ƒê√£ g·ªçi m√≥n</option>
    //                         <option value="COMPLETED" ${data.status==='COMPLETED'?'selected':''}>Ho√†n th√†nh</option>
    //                         <option value="CANCELLED" ${data.status==='CANCELLED'?'selected':''}>ƒê√£ h·ªßy</option>
    //                     </select>
    //                 </div>
    //             </div>
    //
    //             <div style="margin-bottom:15px;">
    //                 <label><b>Kh√°ch h√†ng:</b></label>
    //                 <input type="text" value="${data.customerName}" disabled
    //                        style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
    //             </div>
    //
    //             <div style="margin-bottom:15px;">
    //                 <label><b>S·ªë ƒëi·ªán tho·∫°i:</b></label>
    //                 <input type="text" value="${data.customerPhone}" disabled
    //                        style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
    //             </div>
    //
    //             <div style="margin-bottom:15px;">
    //                 <label><b>Ghi ch√∫:</b></label>
    //                 <textarea id="editNote" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;" rows="3">${data.note || ''}</textarea>
    //             </div>
    //
    //             <h4 style="margin-top:20px;">Danh s√°ch m√≥n</h4>
    //             <div id="editItemsList" style="max-height:300px; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:8px;">
    //         `;
    //
    //             data.items.forEach(i => {
    //                 html += `
    //                 <div style="display:flex; gap:10px; align-items:center; padding:8px 0; border-bottom:1px solid #eee;">
    //                     <input type="text" value="${i.dishName}" disabled style="flex:1;">
    //                     <input type="number" min="1" class="item-qty" data-id="${i.id}" value="${i.quantity}" style="width:80px;">
    //                 </div>
    //             `;
    //             });
    //
    //             html += `</div>`;
    //
    //             document.getElementById("editOrderContent").innerHTML = html;
    //             document.getElementById("editOrderModal").style.display = "flex";
    //         });
    // }

    let selectedCustomerId = null;

    function searchCustomer(keyword) {
        if (!keyword.trim()) {
            document.getElementById("customerResultBox").style.display = "none";
            return;
        }

        fetch(`/api/customers/search?keyword=${keyword}`)
            .then(r => r.json())
            .then(list => {
                const box = document.getElementById("customerResultBox");
                box.innerHTML = "";
                box.style.display = "block";

                list.forEach(c => {
                    box.innerHTML += `
                    <div onclick="chooseCustomer(${c.id}, '${c.fullName}', '${c.phone}')"
                         style="padding:6px;cursor:pointer;">
                        ${c.fullName} - ${c.phone}
                    </div>`;
                });
            });
    }
    function chooseCustomer(id, name, phone) {
        selectedCustomerId = id;

        document.getElementById("editCustomerSearch").value = name + " - " + phone;
        document.getElementById("editCustomerSearch").disabled = true;
        document.getElementById("customerResultBox").style.display = "none";

        document.getElementById("resetCustomerBtn").style.display = "inline-block";
    }

    function resetCustomerSelect() {
        selectedCustomerId = null;

        const input = document.getElementById("editCustomerSearch");
        input.disabled = false;
        input.value = "";
        input.focus();

        document.getElementById("resetCustomerBtn").style.display = "none";
    }


    function addNewItemRow() {
        const list = document.getElementById("editItemsList");

        list.insertAdjacentHTML("beforeend", `
        <div class="item-row" style="display:flex;gap:10px;margin-bottom:8px;align-items:center;">
            <select class="dish-select" onchange="lockDishSelect(this)"
                    style="flex:1;padding:6px;border-radius:6px;border:1px solid #ddd;">
                <option value="">-- Ch·ªçn m√≥n --</option>
            </select>
            <input type="number" class="item-qty-new" value="1" min="1" style="width:80px;">
            <span onclick="this.parentElement.remove()" style="cursor:pointer;color:red;font-weight:bold;">√ó</span>
        </div>
    `);

        fetch("/api/dishes")
            .then(r => r.json())
            .then(dishes => {
                const select = list.lastElementChild.querySelector(".dish-select");
                dishes.forEach(d => {
                    select.innerHTML += `<option value="${d.id}">${d.dishName}</option>`;
                });
            });
    }



    function lockDishSelect(sel) {
        const id = sel.value;
        const name = sel.options[sel.selectedIndex].text;

        if (!id) return;

        sel.outerHTML = `
        <input type="text" value="${name}" disabled style="flex:1;" data-dish="${id}">
    `;
    }






    // Th√™m m√≥n m·ªõi
    // function addNewItemRow() {
    //     const list = document.getElementById("editItemsList");
    //     list.insertAdjacentHTML('beforeend', `
    //     <div style="display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid #eee;">
    //         <input type="text" placeholder="T√™n m√≥n" style="flex:1;">
    //         <input type="number" placeholder="SL" min="1" class="item-qty" style="width:80px;">
    //         <span onclick="this.parentElement.remove()" style="color:red; cursor:pointer;">√ó</span>
    //     </div>
    // `);
    // }


    function saveOrderChanges() {
        const orderId = document.getElementById("editOrderId").textContent;

        // ===== CHECK KH√ÅCH =====
        const hasPhoneMode = document.getElementById("editCustomerSearch") !== null;
        if (hasPhoneMode && !selectedCustomerId) {
            alert("Vui l√≤ng ch·ªçn kh√°ch h√†ng t·ª´ danh s√°ch!");
            return;
        }

        // ===== L·∫§Y M√ìN =====
        const items = [];

        document.querySelectorAll("#editItemsList .item-row").forEach(row => {

            const dishInput = row.querySelector("[data-dish]");
            if (!dishInput) return;

            const dishId = dishInput.dataset.dish;

            let qty = null;

            if (row.querySelector(".item-qty"))
                qty = row.querySelector(".item-qty").value;

            if (row.querySelector(".item-qty-new"))
                qty = row.querySelector(".item-qty-new").value;

            if (qty && parseInt(qty) > 0) {
                items.push({
                    dishId: dishId,
                    quantity: parseInt(qty)
                });
            }
        });


        // ===== KH√ÅCH =====
        let customerId = selectedCustomerId || null;
        let customerName = null;
        let customerPhone = null;

        if (!customerId) {
            customerName = document.getElementById("editCustomerName")?.value || null;
            customerPhone = document.getElementById("editCustomerPhone")?.value || null;
        }

        const body = {
            tableId: document.getElementById("editTable").value,
            status: document.getElementById("editStatus").value,
            note: document.getElementById("editNote").value,
            items,
            customerId,
            customerName,
            customerPhone
        };

        // ===== G·ª¨I L√äN BACKEND =====
        fetch(`/orders/${orderId}/update`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        }).then(async r => {
            const msg = await r.text();
            alert(msg);
            if (r.ok) location.reload();
        });
    }




    function closeEditModal() {
        document.getElementById("editOrderModal").style.display = "none";
    }


    //  nh·∫•n ra ngo√†i l√† n√≥ ƒë√≥ng
    // window.addEventListener("click", function(e) {
    //     const modal = document.getElementById("editOrderModal");
    //     if (e.target === modal) {
    //         modal.style.display = "none";
    //     }
    // });



    // L∆∞u thay ƒë·ªïi
    // function saveOrderChanges() {
    //     const orderId = document.getElementById("editOrderId").textContent;
    //     const status = document.getElementById("editStatus").value;
    //     const note = document.getElementById("editNote").value;
    //
    //     const items = [];
    //     document.querySelectorAll("#editItemsList .item-qty").forEach(i => {
    //         items.push({
    //             id: i.dataset.id,
    //             quantity: parseInt(i.value)
    //         });
    //     });
    //
    //     fetch(`/orders/${orderId}/update`, {
    //         method: "PUT",
    //         headers: { "Content-Type": "application/json" },
    //         body: JSON.stringify({ status, note, items })
    //     })
    //         .then(r => r.ok ? (alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!"), location.reload())
    //             : alert("L·ªói khi l∆∞u!"));
    // }
    //
    // // ƒê√≥ng popup
    // function closeEditModal() {
    //     document.getElementById("editOrderModal").style.display = "none";
    // }














    // x√≥a




    let deleteOrderId = null;

    function openDeleteOrder(orderId) {
        deleteOrderId = orderId;

        fetch(`/orders/${orderId}/info`)
            .then(r => r.json())
            .then(data => {
                document.getElementById("deleteInfo").innerHTML = `
                <div><b>B√†n:</b> ${data.tableName}</div>
                <div><b>Kh√°ch:</b> ${data.customerName}</div>
                <div><b>SƒêT:</b> ${data.customerPhone}</div>
                <div><b>Ghi ch√∫:</b> ${data.note || '‚Äî'}</div>
            `;
                document.getElementById("deleteOrderModal").style.display = "flex";
            });
    }

    function closeDeleteModal() {
        document.getElementById("deleteOrderModal").style.display = "none";
    }

    function confirmDeleteOrder() {
        fetch(`/orders/${deleteOrderId}`, { method: "DELETE" })
            .then(async r => {
                const text = await r.text(); // L·∫•y message do controller tr·∫£ v·ªÅ

                if (r.ok) {
                    alert(text);            // In ra th√¥ng b√°o th√†nh c√¥ng
                    location.reload();
                } else {
                    alert(text);            // In ra th√¥ng b√°o l·ªói t·ª´ controller
                }
            });
    }


</script>



</body>
</html>
